<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hierarchical Forecasting with Opera • opera</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Hierarchical Forecasting with Opera">
<meta property="og:description" content="opera">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">opera</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/opera-vignette.html">`opera` package</a>
    </li>
    <li>
      <a href="../articles/regional_forecasting.html">Hierarchical Forecasting with Opera</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dralliag/opera/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Hierarchical Forecasting with Opera</h1>
                        <h4 data-toc-skip class="author">Yannig
Goude</h4>
            
            <h4 data-toc-skip class="date">2023-01-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/dralliag/opera/blob/HEAD/vignettes/regional_forecasting.Rmd" class="external-link"><code>vignettes/regional_forecasting.Rmd</code></a></small>
      <div class="hidden name"><code>regional_forecasting.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="data-presentation">Data presentation<a class="anchor" aria-label="anchor" href="#data-presentation"></a>
</h2>
<p>The data are from <a href="https://opendata.reseaux-energies.fr/" class="external-link">RTE
open data</a> and <a href="https://donneespubliques.meteofrance.fr/" class="external-link">Météo-France</a>. The
problems adress in this notebook are related to forecasting when breaks
occur in the the data generative process and how to deal with it with
statistical machine learning tools like GAMs, RF and online aggregation
of experts in a hierarchical context. The target <span class="math inline">\(y_t\)</span>, the electricity load at time <span class="math inline">\(t\)</span>, is observed sequentially each day, the
experts and the aggregation are thus updates at the same frequency.</p>
<p>The dataset contains <strong>electricity consumption</strong> (in MW)
at the French national level (“Load”) and for the 12 metropolitan
administrative regions (it does not include Corsica):</p>
<ul>
<li>Nouvelle Aquitaine (“Nouvelle_A”)</li>
<li>Auvergne Rhones-Alpes (“Auvergne_R”)</li>
<li>Bourgogne-Franche-Comté (“Bourgogne”)</li>
<li>Occitanie (“Occitanie”)</li>
<li>Hauts-de-France (“Hauts_de_F”)</li>
<li>Normandie (“Normandie”)</li>
<li>Bretagne (“Bretagne”)</li>
<li>Centre-Val de Loire (“Centre_Val”)</li>
<li>Île-de-France (“Ile_de_Fra”)</li>
<li>Pays de la Loire (“Pays_de_la_Loire”)</li>
<li>Provence-Alpes-Côte d’Azur (“Provence_A”)</li>
<li>Grand Est (“Grand_Est”).</li>
</ul>
<p>Our goal is to forecast the French national consumption, exploiting
the regional loads. For all the load consumption data we compute the
lags one day and one week and denote it with the subscripts “.48” and
“.336”.”</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">objects</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://pierre.gaillard.me/opera.html" class="external-link">opera</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">regional_load</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"regional_load.RDS"</span>, package <span class="op">=</span> <span class="st">"opera"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2011</span><span class="op">)</span></span>
<span><span class="va">Data0</span> <span class="op">&lt;-</span> <span class="va">regional_load</span><span class="op">[</span><span class="va">n0</span>,<span class="op">]</span></span>
<span><span class="va">Data1</span> <span class="op">&lt;-</span> <span class="va">regional_load</span><span class="op">[</span><span class="op">-</span><span class="va">n0</span>,<span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">name_reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Nouvelle_A"</span>, <span class="st">"Auvergne_R"</span>, <span class="st">"Bourgogne"</span>, <span class="st">"Occitanie"</span>, </span>
<span>              <span class="st">"Hauts_de_F"</span>, <span class="st">"Normandie"</span>, <span class="st">"Bretagne"</span>, </span>
<span>              <span class="st">"Centre_Val"</span>, <span class="st">"Ile_de_Fra"</span>, <span class="st">"Pays_de_la_Loire"</span>, </span>
<span>              <span class="st">"Provence_A"</span>, <span class="st">"Grand_Est"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nb.cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">name_reg</span><span class="op">)</span></span>
<span><span class="va">col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">8</span>, <span class="st">"Set3"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="va">nb.cols</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">Data0</span><span class="op">$</span><span class="va">Date</span>, <span class="va">Data0</span><span class="op">[</span>,<span class="va">name_reg</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">'l'</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">Data0</span><span class="op">$</span><span class="va">Date</span>, <span class="va">Data1</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">'Regional load (MW)'</span>, xlab <span class="op">=</span> <span class="st">"Date"</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">Data0</span><span class="op">[</span>,<span class="va">name_reg</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">$</span><span class="va">Date</span>, <span class="va">Data1</span><span class="op">[</span>,<span class="va">name_reg</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, lty <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">name_reg</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">Data0</span><span class="op">$</span><span class="va">Date</span>, <span class="va">Data0</span><span class="op">[</span>,<span class="va">name_reg</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">$</span><span class="va">Date</span>, <span class="va">Data1</span><span class="op">[</span>,<span class="va">name_reg</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">col</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">'l'</span>, lty <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Date</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, lty <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></span></code></pre></div>
<p><img src="regional_forecasting_files/figure-html/unnamed-chunk-2-1.png" width="681.6"></p>
<p><strong>Meteo Data</strong> have been aggregated by region, we
computed weighted means of meteo stations data with weights proportional
to <span class="math inline">\(\exp(-h d^2)\)</span> where <span class="math inline">\(d\)</span> is the euclidian distance between the
position of the station and the centroid of each regions, temperature
data are denoted <code>T_</code> followed by the name of the region. We
compute the exponential smoothing of these temperatures with
coefficients <span class="math inline">\(\alpha=0.95\)</span> and <span class="math inline">\(0.99\)</span>. E.g. for <span class="math inline">\(\alpha=0.95\)</span> at a given instant <span class="math inline">\(i\)</span>, <span class="math inline">\(\text{T_s95}=\alpha \text{T_s95}_{i-1} +
(1-\alpha) \text{Temp}_i\)</span>, these covariates are denoted with the
subscript <code>_s95</code> or <code>_s99</code>. Finally we compute the
minimal and maximal value of these smooth temperatures for each days and
denote it with the subscript <code>_min</code> and
<code>_max</code>.</p>
<p><strong>Calendar Data</strong> are also included: Date, day of the
week (“WeekDays”), daylight savings (“DLS”) an indicator of
winter/summer hour, an indicator for summer holidays(“Summer_break”), an
indicator for winter holidays(“Christmas_break”), the time of year
(“toy”) whose value grows linearly from 0 on the 1 of January 00h00 to 1
on the 31 of December 23h30.</p>
<p>We split the data in 2, the learning set (when we learn the experts)
contains the data from January 2013 to december 2019. The test set (when
we forecast online) contains the data from January 2020 to april
2021.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">Data0</span><span class="op">$</span><span class="va">Date</span>, <span class="va">Data0</span><span class="op">$</span><span class="va">Load</span>, type <span class="op">=</span> <span class="st">'l'</span>, </span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">Data0</span><span class="op">$</span><span class="va">Date</span>, <span class="va">Data1</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">'National load (MW)'</span>, xlab <span class="op">=</span> <span class="st">"Date"</span>,<span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">$</span><span class="va">Date</span>, <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span>, col <span class="op">=</span> <span class="st">'red'</span>, type <span class="op">=</span> <span class="st">'l'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"learning set"</span>, <span class="st">"test set"</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span>, </span>
<span>       lty <span class="op">=</span> <span class="fl">1</span>, bty <span class="op">=</span> <span class="st">'n'</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Date</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, lty <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></span></code></pre></div>
<p><img src="regional_forecasting_files/figure-html/unnamed-chunk-3-1.png" width="681.6"></p>
</div>
<div class="section level2">
<h2 id="expert-generation">Expert generation<a class="anchor" aria-label="anchor" href="#expert-generation"></a>
</h2>
<p>Here we present the different models we use as experts in the
aggregation. Our experts are obtained by stacked gam/forest regression.
GAM are a powerfull forecasting tool classicaly. It provides
interpretable models and a natural way to incorporate expert knowledge
into a statistical model but can miss some interaction between the
inputs. Moreover, due to smoothness assumptions imposed to GAM
functionals, GAM can extrapolate out of training data. On the other
hand, RF are by definition restricted to the convex envelop of the
training data but their black box design can capture well complex
non-linear interactions. To take the best of both worlds, we propose to
stack these two approaches. We proceed in two steps, first we fit a GAM
(see bellow), then we plug the non-linear transformation of the data
estimated by GAM as supplementary data of a random forest fitted of the
(CV or block CV) residuals of the GAM.</p>
<p>For conciseness, we present here the model at the national level but
we computed the regional model exactly the same with regional target and
covariates.</p>
<div class="section level3">
<h3 id="gam">GAM<a class="anchor" aria-label="anchor" href="#gam"></a>
</h3>
<p>The first model is a gaussian GAM fitted with mgcv package according
to the following equation (here for the national load, for regional just
change the target and covariates in accordance).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eq</span> <span class="op">&lt;-</span> <span class="va">Load</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span>, k<span class="op">=</span><span class="fl">3</span><span class="op">)</span>  <span class="op">+</span> <span class="va">WeekDays</span><span class="op">:</span><span class="va">DLS</span>  <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">toy</span>, k <span class="op">=</span> <span class="fl">20</span>, bs <span class="op">=</span> <span class="st">'cc'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span>,<span class="va">T_national</span>, k<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">T_national_s95</span>, k<span class="op">=</span><span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">T_national_s99</span>, k<span class="op">=</span><span class="fl">5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">T_national_s99_min</span>, <span class="va">T_national_s99_max</span><span class="op">)</span> <span class="op">+</span> <span class="va">Load.48</span><span class="op">:</span><span class="va">WeekDays</span> <span class="op">+</span> <span class="va">Load.336</span> </span>
<span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">eq</span> , data <span class="op">=</span> <span class="va">Data0</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></span>
<span><span class="va">gam_nat.forecast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">g</span>, newdata <span class="op">=</span> <span class="va">Data1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="stacked-rf-and-stacked-quantile-rf">Stacked RF and stacked quantile RF<a class="anchor" aria-label="anchor" href="#stacked-rf-and-stacked-quantile-rf"></a>
</h3>
<p>We proceed in two steps:</p>
<p>The parameter of the RF are the default parameters (<span class="math inline">\(500\)</span> trees, <span class="math inline">\(mtry=\sqrt{p}\)</span>, unlimited tree depth)
where <span class="math inline">\(p\)</span> is now the number of
covariates plus the number of GAM features.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### extract the GAM terms</span></span>
<span><span class="va">terms0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">g</span>, newdata <span class="op">=</span> <span class="va">Data0</span>, type <span class="op">=</span> <span class="st">'terms'</span><span class="op">)</span></span>
<span><span class="va">terms1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">g</span>, newdata <span class="op">=</span> <span class="va">Data1</span>, type <span class="op">=</span> <span class="st">'terms'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">terms0</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"gterms_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">terms0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">terms1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"gterms_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">terms1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### include it in the stacked RF</span></span>
<span><span class="co">#### first build a data frame</span></span>
<span><span class="va">data0_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">Data0</span>, <span class="va">terms0</span><span class="op">)</span></span>
<span><span class="va">data0_rf</span><span class="op">$</span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">g</span><span class="op">$</span><span class="va">residuals</span>  <span class="co"># fitted residuals of the GAM</span></span>
<span><span class="va">data0_rf</span><span class="op">$</span><span class="va">res.48</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">data0_rf</span><span class="op">$</span><span class="va">res</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">data0_rf</span><span class="op">$</span><span class="va">res</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data0_rf</span><span class="op">$</span><span class="va">res</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>  <span class="co"># lags of the fitted residuals</span></span>
<span><span class="va">data0_rf</span><span class="op">$</span><span class="va">res.336</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">data0_rf</span><span class="op">$</span><span class="va">res</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span>, <span class="va">data0_rf</span><span class="op">$</span><span class="va">res</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data0_rf</span><span class="op">$</span><span class="va">res</span><span class="op">)</span><span class="op">-</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data1_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">Data1</span>, <span class="va">terms1</span><span class="op">)</span></span>
<span><span class="va">data1_rf</span><span class="op">$</span><span class="va">g.forecast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">g</span>, newdata<span class="op">=</span><span class="va">Data1</span><span class="op">)</span></span>
<span><span class="va">residuals</span> <span class="op">&lt;-</span> <span class="va">data1_rf</span><span class="op">$</span><span class="va">Load</span> <span class="op">-</span>  <span class="va">data1_rf</span><span class="op">$</span><span class="va">g.forecast</span> <span class="co">#forecast  residuals</span></span>
<span><span class="va">data1_rf</span><span class="op">$</span><span class="va">res.48</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">residuals</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="co">#lags of the forecast residuals</span></span>
<span><span class="va">data1_rf</span><span class="op">$</span><span class="va">res.336</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span>, <span class="va">residuals</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span><span class="op">-</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### equation of the RF</span></span>
<span><span class="va">cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Load'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">".48"</span>, <span class="st">".336"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'T_'</span>, <span class="st">"national"</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'T_'</span>, <span class="st">"national"</span>, <span class="st">'_s99'</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'T_'</span>, <span class="st">"national"</span>, <span class="st">'_s95'</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'T_'</span>, <span class="st">"national"</span>, <span class="st">'_s95_min'</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'T_'</span>, <span class="st">"national"</span>, <span class="st">'_s95_max'</span><span class="op">)</span>,</span>
<span>         <span class="st">'toy'</span>, <span class="st">'BH'</span>, <span class="st">'tod'</span>, <span class="st">'DLS'</span>, <span class="st">'Summer_break'</span>, <span class="st">'Christmas_break'</span>, <span class="st">'res.48'</span>, <span class="st">'res.336'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gterm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"gterms_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">terms0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cov</span>, <span class="va">gterm</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">'+'</span><span class="op">)</span></span>
<span><span class="va">formule_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"res"</span>, <span class="st">"~"</span>, <span class="va">cov</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gamrf_nat</span> <span class="op">&lt;-</span> <span class="fu">ranger</span><span class="fu">::</span><span class="fu">ranger</span><span class="op">(</span><span class="va">formule_rf</span>, data <span class="op">=</span> <span class="va">data0_rf</span>, quantreg <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>These stacked forest can easily provide quantile estimates. This is
particularly useful to design experts for low and high quantiles which
can then be aggregated online to track the changes in the distribution
of the load. For each region and at the national level we consider 5
experts associated to quantiles 0.05, 0.1,0.5,0.9 and 0.95. This choice
of individual is particulary well suited for online convex aggregation
(there is a high probability that the real consumption fall in the
convex hull of the quantiles experts). Here is the example on stacked
forest implementation for national data:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="fl">0.9</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="va">gamrf_nat.forecast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">gamrf_nat</span>, data <span class="op">=</span> <span class="va">data1_rf</span>, quantiles <span class="op">=</span> <span class="va">qu</span>, type<span class="op">=</span><span class="st">'quantiles'</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">gam_nat.forecast</span><span class="op">)</span></span></code></pre></div>
<p>To provide relevant experts at the national level from regional ones
we rescale each expert this way:</p>
<p><span class="math inline">\(\widehat{y}_{regional} :=
\widehat{y}_{regional} * \frac{\sum_{t=1}^{T_0}
y_t^{national}}{\sum_{t=1}^{T_0} y_t^{regional}}\)</span></p>
</div>
</div>
<div class="section level2">
<h2 id="aggregation">Aggregation<a class="anchor" aria-label="anchor" href="#aggregation"></a>
</h2>
<p>Here we describe the different aggregation approaches that can be
performed in this framework:</p>
<ul>
<li><p><strong>Full desagregated</strong>: using the full set of scaled
experts as experts (65 experts, 5 by regions + 5 at the national level)
and the national demand as our target variable.</p></li>
<li><p><strong>Hierarchical aggregation</strong>: in each region we
aggregate the 5 experts using the regional demand as a target, we
obtained 12 experts + the quantile 0.5 expert of the national level that
are aggregated with the national demand as our target variable.</p></li>
<li><p><strong>Vectorial aggregation</strong>: we illustrate the
possibility to share weights between the region and at the national
level. here the experts are the 5 quantiles stacked RF in each regions
and the (vectorial) target is the vector of loads in each regions and at
the national level. The implicit model behind that kind of aggregation
is that when an expert receive a low weigths in a region, it has to
receive a low weight in all region simultaneously.</p></li>
</ul>
<div class="section level3">
<h3 id="full-desagregated">Full desagregated<a class="anchor" aria-label="anchor" href="#full-desagregated"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">experts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"regional_experts.RDS"</span>, package <span class="op">=</span> <span class="st">"opera"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">experts_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"regional_experts_raw.RDS"</span>, package <span class="op">=</span> <span class="st">"opera"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">experts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 398  65</span></span>
<span><span class="va">agg</span> <span class="op">&lt;-</span> <span class="fu">opera</span><span class="fu">::</span><span class="fu"><a href="../reference/mixture-opera.html">mixture</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">$</span><span class="va">Load</span><span class="op">)</span>, experts<span class="op">=</span><span class="va">experts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Run if you want to see dynamic ploy</span></span>
<span><span class="co"># plot(agg)</span></span>
<span></span>
<span><span class="va">mape</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">ychap</span>, <span class="va">digits</span> <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">ychap</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,digits<span class="op">=</span><span class="va">digits</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## RTE national forecast, dayahead</span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span>, ychap <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Forecast_RTE_dayahead</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] 1.58</span></span>
<span><span class="co">## National forecast</span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span>, ychap <span class="op">=</span> <span class="va">experts</span><span class="op">[</span>,  <span class="st">"nat0.5"</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] 2.04</span></span>
<span><span class="co">## Aggregation </span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span>, ychap <span class="op">=</span> <span class="va">agg</span><span class="op">$</span><span class="va">prediction</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] 1.38</span></span>
<span><span class="co">## sum of regional forecast</span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span>, ychap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">experts_raw</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"0.5"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">experts_raw</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] 1.81</span></span>
<span></span>
<span><span class="co">## Pre_covid</span></span>
<span><span class="va">pre_covid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">$</span><span class="va">Date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strptime.html" class="external-link">strptime</a></span><span class="op">(</span><span class="st">"2019-09-01 00:00:00"</span>, <span class="st">"%Y-%m-%d %H:%M:%S"</span><span class="op">)</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>                 <span class="va">Data1</span><span class="op">$</span><span class="va">Date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strptime.html" class="external-link">strptime</a></span><span class="op">(</span><span class="st">"2020-03-16 00:00:00"</span>, <span class="st">"%Y-%m-%d %H:%M:%S"</span><span class="op">)</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span><span class="op">[</span><span class="va">pre_covid</span><span class="op">]</span>, ychap <span class="op">=</span> <span class="va">agg</span><span class="op">$</span><span class="va">prediction</span><span class="op">[</span><span class="va">pre_covid</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.33</span></span>
<span></span>
<span><span class="co">## hard lockdown</span></span>
<span><span class="va">hard_lockdown</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">$</span><span class="va">Date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strptime.html" class="external-link">strptime</a></span><span class="op">(</span><span class="st">"2020-03-16 00:00:00"</span>, <span class="st">"%Y-%m-%d %H:%M:%S"</span><span class="op">)</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>                 <span class="va">Data1</span><span class="op">$</span><span class="va">Date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strptime.html" class="external-link">strptime</a></span><span class="op">(</span><span class="st">"2020-04-16 00:00:00"</span>, <span class="st">"%Y-%m-%d %H:%M:%S"</span><span class="op">)</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span><span class="op">[</span><span class="va">hard_lockdown</span><span class="op">]</span>, ychap <span class="op">=</span> <span class="va">agg</span><span class="op">$</span><span class="va">prediction</span><span class="op">[</span><span class="va">hard_lockdown</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2.71</span></span>
<span></span>
<span><span class="co">## "post" lockdown</span></span>
<span><span class="va">post_lockdown</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">$</span><span class="va">Date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strptime.html" class="external-link">strptime</a></span><span class="op">(</span><span class="st">"2020-04-16 00:00:00"</span>, <span class="st">"%Y-%m-%d %H:%M:%S"</span><span class="op">)</span>, tz<span class="op">=</span><span class="st">"UTC"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span><span class="op">[</span><span class="va">post_lockdown</span><span class="op">]</span>, ychap <span class="op">=</span> <span class="va">agg</span><span class="op">$</span><span class="va">prediction</span><span class="op">[</span><span class="va">post_lockdown</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.28</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="hierarchical-aggregation">Hierarchical aggregation<a class="anchor" aria-label="anchor" href="#hierarchical-aggregation"></a>
</h3>
<!-- # ```{r} -->
<!-- # ####solution 2: aggregation by region then national aggregation -->
<!-- # experts <- cbind(experts[,  "nat0.5"], import$agg.forecast_scale) -->
<!-- # agg_hierar<- opera::mixture(Y=as.numeric(Data1$Load), experts=experts) -->
<!-- # plot(agg_hierar) -->
<!-- # mape(y=Data1$Load, ychap=agg_hierar$prediction) ##1.37 -->
<!-- # summary(agg_hierar) -->
<!-- #  -->
<!-- # ``` -->
<!-- Hierarchical aggregation achieves similar results than fully disaggregated approach, this illustrates the fact that online robust aggregation methods scale well with the number of experts which is in favor of including more diverse experts in the aggregation. -->
</div>
<div class="section level3">
<h3 id="vectorial-weights">Vectorial weights<a class="anchor" aria-label="anchor" href="#vectorial-weights"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">reg_scale</span> <span class="op">&lt;-</span> <span class="va">Data1</span><span class="op">[</span>,  <span class="va">name_reg</span><span class="op">]</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Data0</span><span class="op">$</span><span class="va">Load</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">Data0</span><span class="op">[</span>,<span class="va">name_reg</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">name_reg</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, byrow <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Load"</span>, <span class="va">name_reg</span><span class="op">)</span><span class="op">]</span><span class="op">*</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="va">experts2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">name_reg</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">name</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nat"</span>, <span class="va">name_reg</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">name_reg</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">experts2</span><span class="op">[</span>,<span class="va">k</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">experts</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="va">name</span><span class="op">[</span><span class="va">k</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">experts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">agg_vector</span><span class="op">&lt;-</span> <span class="fu">opera</span><span class="fu">::</span><span class="fu"><a href="../reference/mixture-opera.html">mixture</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, experts <span class="op">=</span> <span class="va">experts2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">agg_vector</span>, dynamic <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="regional_forecasting_files/figure-html/unnamed-chunk-8-1.png" width="681.6"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot(agg_vector)</span></span>
<span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span>, ychap <span class="op">=</span> <span class="va">agg_vector</span><span class="op">$</span><span class="va">prediction</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] 1.87</span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span><span class="op">[</span><span class="va">pre_covid</span><span class="op">]</span>, ychap <span class="op">=</span> <span class="va">agg_vector</span><span class="op">$</span><span class="va">prediction</span><span class="op">[</span><span class="va">pre_covid</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.04</span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span><span class="op">[</span><span class="va">hard_lockdown</span><span class="op">]</span>, ychap <span class="op">=</span> <span class="va">agg_vector</span><span class="op">$</span><span class="va">prediction</span><span class="op">[</span><span class="va">hard_lockdown</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5.56</span></span>
<span><span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span><span class="op">[</span><span class="va">post_lockdown</span><span class="op">]</span>, ychap <span class="op">=</span> <span class="va">agg_vector</span><span class="op">$</span><span class="va">prediction</span><span class="op">[</span><span class="va">post_lockdown</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.73</span></span></code></pre></div>
<p>The performances are significantly better with vectorial weights
before 2020, when the lockdown due to the COVID 19 affected the
consumption. During the lockdown the performances are bad, meaning that
the impact of the lockdown was not simular during the different regions.
That can be partly explained as the impact of the pandemy on consumption
really depends on social, demographyc and economic profile of the
region. Furthermore, the dynamic of the pandemy was bot simultaneous
between the regions.</p>
</div>
</div>
<div class="section level2">
<h2 id="forecasting-at-extended-horizons">Forecasting at extended horizons<a class="anchor" aria-label="anchor" href="#forecasting-at-extended-horizons"></a>
</h2>
<p>Foresting at different horizon is an important need in time series
analysis. By default the mixture function learn the weights and produce
the aggregation forecasts in an online fashion, supposing horizon 1 for
both the expert and the aggregation.</p>
<p>Suppose we want to produce each day a forecast at horizon <span class="math inline">\(h=10\)</span>, a possible way to do it is:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">experts</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Data1</span><span class="op">$</span><span class="va">Load</span></span>
<span><span class="va">agg</span> <span class="op">&lt;-</span> <span class="fu">opera</span><span class="fu">::</span><span class="fu"><a href="../reference/mixture-opera.html">mixture</a></span><span class="op">(</span>Y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Data1</span><span class="op">$</span><span class="va">Load</span><span class="op">)</span>, experts<span class="op">=</span><span class="va">experts</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">change_horizon</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">h</span>, <span class="va">agg</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">## the h first weights stay equal to inital values of the weights</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">agg</span><span class="op">$</span><span class="va">weights</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>, <span class="va">h</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">agg</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">dim</span> </span>
<span>  <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">agg</span><span class="op">$</span><span class="va">weights</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>, <span class="va">h</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">agg</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">)</span>, <span class="va">agg</span><span class="op">$</span><span class="va">weights</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">agg</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span><span class="op">-</span><span class="va">h</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">agg_horizon</span> <span class="op">&lt;-</span> <span class="va">agg</span></span>
<span>  <span class="va">agg_horizon</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">w</span></span>
<span>  <span class="va">agg_horizon</span><span class="op">$</span><span class="va">prediction</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">w</span><span class="op">*</span><span class="va">agg</span><span class="op">$</span><span class="va">experts</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">agg_horizon</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">map_horizon</span> <span class="op">&lt;-</span> <span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Y</span>, ychap <span class="op">=</span> <span class="va">agg</span><span class="op">$</span><span class="va">prediction</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">h</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">agg_horizon</span> <span class="op">&lt;-</span> <span class="fu">change_horizon</span><span class="op">(</span>h <span class="op">=</span> <span class="va">h</span>, <span class="va">agg</span><span class="op">)</span></span>
<span>  <span class="va">map_horizon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">map_horizon</span>, <span class="fu">mape</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Y</span>, ychap <span class="op">=</span> <span class="va">agg_horizon</span><span class="op">$</span><span class="va">prediction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">map_horizon</span>, type<span class="op">=</span><span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<p><img src="regional_forecasting_files/figure-html/unnamed-chunk-9-1.png" width="681.6"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Pierre Gaillard.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
