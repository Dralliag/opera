<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Compute an aggregation rule — mixture • opera</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Compute an aggregation rule — mixture" />
<meta property="og:description" content="The function mixture builds an
aggregation rule chosen by the user. 
It can then be used to predict new observations Y sequentially.
If observations Y and expert advice experts are provided, 
mixture is trained by predicting the observations in Y
sequentially with the help of the expert advice in experts.  
At each time instance \(t=1,2,\dots,T\), the mixture forms a prediction of Y[t,] by assigning 
a weight to each expert and by combining the expert advice." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">opera</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/opera-vignette.html">`opera` package</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/dralliag/opera/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Compute an aggregation rule</h1>
    <small class="dont-index">Source: <a href='https://github.com/dralliag/opera/blob/master/R/mixture.R'><code>R/mixture.R</code></a>, <a href='https://github.com/dralliag/opera/blob/master/R/print-mixture.R'><code>R/print-mixture.R</code></a>, <a href='https://github.com/dralliag/opera/blob/master/R/summary-mixture.R'><code>R/summary-mixture.R</code></a></small>
    <div class="hidden name"><code>mixture.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>The function <code>mixture</code> builds an
aggregation rule chosen by the user. 
It can then be used to predict new observations Y sequentially.
If observations <code>Y</code> and expert advice <code>experts</code> are provided, 
<code>mixture</code> is trained by predicting the observations in <code>Y</code>
sequentially with the help of the expert advice in <code>experts</code>.  
At each time instance \(t=1,2,\dots,T\), the mixture forms a prediction of <code>Y[t,]</code> by assigning 
a weight to each expert and by combining the expert advice.</p>
    </div>

    <pre class="usage"><span class='fu'>mixture</span><span class='op'>(</span>
  Y <span class='op'>=</span> <span class='cn'>NULL</span>,
  experts <span class='op'>=</span> <span class='cn'>NULL</span>,
  model <span class='op'>=</span> <span class='st'>"MLpol"</span>,
  loss.type <span class='op'>=</span> <span class='st'>"square"</span>,
  loss.gradient <span class='op'>=</span> <span class='cn'>TRUE</span>,
  coefficients <span class='op'>=</span> <span class='st'>"Uniform"</span>,
  awake <span class='op'>=</span> <span class='cn'>NULL</span>,
  parameters <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='co'># S3 method for mixture</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>...</span><span class='op'>)</span>

<span class='co'># S3 method for mixture</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>object</span>, <span class='va'>...</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>Y</th>
      <td><p>A matrix with T rows and d columns. Each row <code>Y[t,]</code> contains a d-dimensional 
observation to be predicted sequentially.</p></td>
    </tr>
    <tr>
      <th>experts</th>
      <td><p>An array of dimension <code><a href='https://rdrr.io/r/base/c.html'>c(T,d,K)</a></code>, where <code>T</code> is the length of the data-set, 
<code>d</code> the dimension of the observations, and <code>K</code> is the number of experts. It contains the expert
forecasts. Each vector <code>experts[t,,k]</code> corresponds to the d-dimensional prediction of <code>Y[t,]</code> 
proposed by expert k at time \(t=1,\dots,T\).
In the case of real prediction (i.e., \(d = 1\)), <code>experts</code> is a matrix with <code>T</code> rows and <code>K</code> columns.</p></td>
    </tr>
    <tr>
      <th>model</th>
      <td><p>A character string specifying the aggregation rule to use. 
Currently available aggregation rules are:</p><dl>
   <dt>'EWA'</dt><dd><p>Exponentially weighted average aggregation rule. A positive learning rate <strong>eta</strong> 
can be chosen by the user. The
bigger it is the faster the aggregation rule will learn from observations
and experts performances. However, too high values lead to unstable weight
vectors and thus unstable predictions. If it is not specified, the learning rate is calibrated online. 
A finite grid of potential learning rates to be optimized online can be specified with <strong>grid.eta</strong>.</p></dd>
   <dt>'FS'</dt><dd><p>Fixed-share aggregation rule. As for <code>ewa</code>, a learning rate <strong>eta</strong> 
can be chosen by the user or calibrated online. The main difference with <code>ewa</code> aggregation
rule rely in the mixing rate <strong>alpha</strong>\(\in [0,1]\) wich considers at
each instance a small probability <code>alpha</code> to have a rupture in the
sequence and that the best expert may change. Fixed-share aggregation rule
can thus compete with the best sequence of experts that can change a few
times (see <code><a href='oracle.html'>oracle</a></code>), while <code>ewa</code> can only
compete with the best fixed expert. The mixing rate <strong>alpha</strong> is either chosen by the user either calibrated online.
Finite grids of learning rates and mixing rates to be optimized can be specified with 
parameters <strong>grid.eta</strong> and <strong>grid.alpha</strong>.</p></dd>
   <dt>'Ridge'</dt><dd><p>Ridge regression. It minimizes at
each instance a penalized criterion.  It forms at each instance linear
combination of the experts' forecasts and can assign negative weights that
not necessarily sum to one.  It is useful if the experts are biased or
correlated. It cannot be used with specialized experts. A positive regularization coefficient <strong>lambda</strong> 
can either be chosen by the user or calibrated online. 
A finite grid of coefficient to be optimized can be specified with a parameter <strong>grid.lambda</strong>.</p></dd>
   <dt>'MLpol'</dt><dd><p>Polynomial Potential aggregation rule
with different learning rates for each expert.  The learning rates are
calibrated using theoretical values. There are similar aggregation rules 
like 'BOA' (Bernstein online Aggregation see [Wintenberger, 2014] &lt;doi:10.1007/s10994-016-5592-6&gt;, 'MLewa', and 'MLprod' 
(see [Gaillard, Erven, and Stoltz, 2014])</p></dd> 
 <dt>'OGD'</dt><dd><p>Online Gradient descent (see Zinkevich, 2003). The optimization is performed with a time-varying learning rate. 
 At time step \(t \geq 1\), the learning rate is chosen to be \(t^{-\alpha}\), where \(\alpha\) is provided by alpha in the parameters argument.
 The algorithm may or not perform a projection step into the simplex space (non-negative weights that sum to one) according to
 the value of the parameter 'simplex' provided by the user.</p></dd>

</dl></td>
    </tr>
    <tr>
      <th>loss.type</th>
      <td><p>A string or a list with a component 'name' specifying
the loss function considered to evaluate the performance. It can be
'square', 'absolute', 'percentage', or 'pinball'. In the case of the pinball loss, the quantile 
can be provided by assigning to loss.type a list of two elements:</p><dl>
     <dt>name</dt><dd><p>A string defining the name of the loss function (i.e., 'pinball')</p></dd>
     <dt>tau</dt><dd><p>A number in <code>[0,1]</code> defining the quantile to be predicted. 
The default value is 0.5 to predict the median.</p></dd>

</dl><p>'Ridge' aggregation rule is restricted to square loss.</p></td>
    </tr>
    <tr>
      <th>loss.gradient</th>
      <td><p>A boolean. If
TRUE (default) the aggregation rule will not be directly applied to the loss
function at hand but to a gradient version of it.  The aggregation rule is
then similar to gradient descent aggregation rule.</p></td>
    </tr>
    <tr>
      <th>coefficients</th>
      <td><p>A probability vector of length K containing the prior weights of the experts
(not possible for 'MLpol'). The weights must be non-negative and sum to 1.</p></td>
    </tr>
    <tr>
      <th>awake</th>
      <td><p>A matrix specifying the
activation coefficients of the experts. Its entries lie in <code>[0,1]</code>.
Possible if some experts are specialists and do not always form and suggest
prediction. If the expert number <code>k</code> at instance <code>t</code> does not
form any prediction of observation <code>Y_t</code>, we can put
<code>awake[t,k]=0</code> so that the mixture does not consider expert <code>k</code> in
the mixture to predict <code>Y_t</code>.</p></td>
    </tr>
    <tr>
      <th>parameters</th>
      <td><p>A list that contains optional parameters for the aggregation rule. 
If no parameters are provided, the aggregation rule is fully calibrated
online. Possible parameters are:</p><dl>
   <dt>eta</dt><dd><p>A positive number defining the learning rate. 
   Possible if model is either 'EWA' or 'FS'</p></dd>
   <dt>grid.eta</dt><dd><p>A vector of positive numbers defining potential learning rates 
   for 'EWA' of 'FS'.
   The learning rate is then calibrated by sequentially optimizing the parameter in 
   the grid. The grid may be extended online if needed by the aggregation rule.</p></dd>
   <dt>gamma</dt><dd><p>A positive number defining the exponential step of extension 
   of grid.eta when it is needed. The default value is 2.</p></dd>
   <dt>alpha</dt><dd><p>A number in [0,1]. If the model is 'FS', it defines the mixing rate. 
   If the model is 'OGD', it defines the order of the learning rate: \(\eta_t = t^{-\alpha}\).</p></dd>
   <dt>grid.alpha</dt><dd><p>A vector of numbers in [0,1] defining potential mixing rates for 'FS'
   to be optimized online. The grid is fixed over time. The default value is <code>[0.0001,0.001,0.01,0.1]</code>.</p></dd>
   <dt>lambda</dt><dd><p>A positive number defining the smoothing parameter of 'Ridge' aggregation rule.</p></dd>
   <dt>grid.lambda</dt><dd><p>Similar to <code>grid.eta</code> for the parameter <code>lambda</code>.</p></dd>
   <dt>simplex</dt><dd><p>A boolean that specifies if 'OGD' does a project on the simplex. In other words,
   if TRUE (default) the online gradient descent will be under the constraint that the weights sum to 1
   and are non-negative. If FALSE, 'OGD' performs an online gradient descent on K dimensional real space.
   without any projection step.</p></dd>
   <dt>averaged</dt><dd><p>A boolean (default is FALSE). If TRUE the coefficients and the weights 
   returned (and used to form the predictions) are averaged over the past. It leads to more stability on the time evolution of the weights but needs
   more regularity assumption on the underlying process genearting the data (i.i.d. for instance).</p></dd>

</dl></td>
    </tr>
    <tr>
      <th>x</th>
      <td><p>An object of class mixture</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Additional parameters</p></td>
    </tr>
    <tr>
      <th>object</th>
      <td><p>An object of class mixture</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>An object of class mixture that can be used to perform new predictions. 
It contains the parameters <code>model</code>, <code>loss.type</code>, <code>loss.gradient</code>,
<code>experts</code>, <code>Y</code>, <code>awake</code>, and the fields</p>
<dt>coefficients</dt><dd><p>A vector of coefficients 
assigned to each expert to perform the next prediction.</p></dd>

<dt>weights </dt><dd><p>A matrix of dimension <code><a href='https://rdrr.io/r/base/c.html'>c(T,K)</a></code>, with
<code>T</code> the number of instances to be predicted and <code>K</code> the number of
experts.  Each row contains the convex combination to form the predictions</p></dd>
<dt>prediction </dt><dd><p>A matrix with <code>T</code> rows and <code>d</code> columns that contains the
predictions outputted by the aggregation rule.</p></dd> 
<dt>loss</dt><dd><p>The average loss (as stated by parameter <code>loss.type</code>) suffered
by the aggregation rule.</p></dd>
<dt>parameters</dt><dd><p>The learning parameters chosen by the aggregation rule or by the user.</p></dd>
<dt>training</dt><dd><p>A list that contains useful temporary information of the 
aggregation rule to be updated and to perform predictions.</p></dd>

    <h2 class="hasAnchor" id="methods-by-class-"><a class="anchor" href="#methods-by-class-"></a>Methods (by class)</h2>

    
<ul>
<li><p><code>mixture</code>: <code>print</code></p></li>
<li><p><code>mixture</code>: <code>summary</code></p></li>
</ul>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p>See <code><a href='opera-package.html'>opera-package</a></code> and opera-vignette for a brief example about how to use the package.</p></div>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Pierre Gaillard &lt;pierre@gaillard.me&gt;</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'>#' </span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='st'><a href='http://pierre.gaillard.me/opera.html'>'opera'</a></span><span class='op'>)</span>  <span class='co'># load the package</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>

<span class='co'># Example: find the best one week ahead forecasting strategy (weekly data)</span>
<span class='co'># packages</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>mgcv</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Loading required package: nlme</span></div><div class='output co'>#&gt; <span class='message'>This is mgcv 1.8-36. For overview type 'help("mgcv-package")'.</span></div><div class='input'>
<span class='co'># import data</span>
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span><span class='op'>(</span><span class='va'>electric_load</span><span class='op'>)</span>
<span class='va'>idx_data_test</span> <span class='op'>&lt;-</span> <span class='fl'>620</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>electric_load</span><span class='op'>)</span>
<span class='va'>data_train</span> <span class='op'>&lt;-</span> <span class='va'>electric_load</span><span class='op'>[</span><span class='op'>-</span><span class='va'>idx_data_test</span>, <span class='op'>]</span>
<span class='va'>data_test</span> <span class='op'>&lt;-</span> <span class='va'>electric_load</span><span class='op'>[</span><span class='va'>idx_data_test</span>, <span class='op'>]</span>

<span class='co'># Build the expert forecasts </span>
<span class='co'># ##########################</span>

<span class='co'># 1) A generalized additive model</span>
<span class='va'>gam.fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/gam.html'>gam</a></span><span class='op'>(</span><span class='va'>Load</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>IPI</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>Temp</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>Time</span>, k<span class='op'>=</span><span class='fl'>3</span><span class='op'>)</span> <span class='op'>+</span> 
                <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>Load1</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>NumWeek</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>data_train</span><span class='op'>)</span>
<span class='va'>gam.forecast</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>gam.fit</span>, newdata <span class='op'>=</span> <span class='va'>data_test</span><span class='op'>)</span>

<span class='co'># 2) An online autoregressive model on the residuals of a medium term model</span>

<span class='co'># Medium term model to remove trend and seasonality (using generalized additive model)</span>
<span class='va'>detrend.fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/gam.html'>gam</a></span><span class='op'>(</span><span class='va'>Load</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>Time</span>,k<span class='op'>=</span><span class='fl'>3</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>NumWeek</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>Temp</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>IPI</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>data_train</span><span class='op'>)</span>
<span class='va'>electric_load</span><span class='op'>$</span><span class='va'>Trend</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>detrend.fit</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>detrend.fit</span>,newdata <span class='op'>=</span> <span class='va'>data_test</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>electric_load</span><span class='op'>$</span><span class='va'>Load.detrend</span> <span class='op'>&lt;-</span> <span class='va'>electric_load</span><span class='op'>$</span><span class='va'>Load</span> <span class='op'>-</span> <span class='va'>electric_load</span><span class='op'>$</span><span class='va'>Trend</span>

<span class='co'># Residual analysis</span>
<span class='va'>ar.forecast</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>numeric</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>idx_data_test</span><span class='op'>)</span><span class='op'>)</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='va'>idx_data_test</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
 <span class='va'>ar.fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/ar.html'>ar</a></span><span class='op'>(</span><span class='va'>electric_load</span><span class='op'>$</span><span class='va'>Load.detrend</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='va'>idx_data_test</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span>
 <span class='va'>ar.forecast</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>ar.fit</span><span class='op'>)</span><span class='op'>$</span><span class='va'>pred</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>electric_load</span><span class='op'>$</span><span class='va'>Trend</span><span class='op'>[</span><span class='va'>idx_data_test</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>]</span>
<span class='op'>}</span>

<span class='co'># Aggregation of experts</span>
<span class='co'>###########################</span>

<span class='va'>X</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>gam.forecast</span>, <span class='va'>ar.forecast</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'gam'</span>, <span class='st'>'ar'</span><span class='op'>)</span>
<span class='va'>Y</span> <span class='op'>&lt;-</span> <span class='va'>data_test</span><span class='op'>$</span><span class='va'>Load</span>

<span class='fu'><a href='https://rdrr.io/r/graphics/matplot.html'>matplot</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>Y</span>, <span class='va'>X</span><span class='op'>)</span>, type <span class='op'>=</span> <span class='st'>'l'</span>, col <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>6</span>, ylab <span class='op'>=</span> <span class='st'>'Weekly load'</span>, xlab <span class='op'>=</span> <span class='st'>'Week'</span><span class='op'>)</span>
</div><div class='img'><img src='mixture-1.png' alt='' width='700' height='433' /></div><div class='input'>

<span class='co'># How good are the expert? Look at the oracles</span>
<span class='va'>oracle.convex</span> <span class='op'>&lt;-</span> <span class='fu'><a href='oracle.html'>oracle</a></span><span class='op'>(</span>Y <span class='op'>=</span> <span class='va'>Y</span>, experts <span class='op'>=</span> <span class='va'>X</span>, loss.type <span class='op'>=</span> <span class='st'>'square'</span>, model <span class='op'>=</span> <span class='st'>'convex'</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='warning'>Warning: The best convex oracle is only approximated (using optim).</span></div><div class='input'><span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>oracle.convex</span><span class='op'>)</span>
</div><div class='img'><img src='mixture-2.png' alt='' width='700' height='433' /></div><div class='input'><span class='va'>oracle.convex</span>
</div><div class='output co'>#&gt; Call:
#&gt; oracle.default(Y = Y, experts = X, model = "convex", loss.type = "square")
#&gt; 
#&gt; Coefficients:
#&gt;    gam    ar
#&gt;  0.751 0.249
#&gt; 
#&gt;                       rmse   mape
#&gt; Best expert oracle:   1480 0.0202
#&gt; Uniform combination:  1480 0.0206
#&gt; Best convex oracle:   1450 0.0200</div><div class='input'>
<span class='co'># Is a single expert the best over time ? Are there breaks ?</span>
<span class='va'>oracle.shift</span> <span class='op'>&lt;-</span> <span class='fu'><a href='oracle.html'>oracle</a></span><span class='op'>(</span>Y <span class='op'>=</span> <span class='va'>Y</span>, experts <span class='op'>=</span> <span class='va'>X</span>, loss.type <span class='op'>=</span> <span class='st'>'percentage'</span>, model <span class='op'>=</span> <span class='st'>'shifting'</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>oracle.shift</span><span class='op'>)</span>
</div><div class='img'><img src='mixture-3.png' alt='' width='700' height='433' /></div><div class='input'><span class='va'>oracle.shift</span>
</div><div class='output co'>#&gt; Call:
#&gt; oracle.default(Y = Y, experts = X, model = "shifting", loss.type = "percentage")
#&gt; 
#&gt;       0 shifts 28 shifts 55 shifts 83 shifts 111 shifts
#&gt; mape:   0.0202    0.0159    0.0154     0.016     0.0209</div><div class='input'>
<span class='co'># Online aggregation of the experts with BOA</span>
<span class='co'>#############################################</span>

<span class='co'># Initialize the aggregation rule</span>
<span class='va'>m0.BOA</span> <span class='op'>&lt;-</span> <span class='fu'>mixture</span><span class='op'>(</span>model <span class='op'>=</span> <span class='st'>'BOA'</span>, loss.type <span class='op'>=</span> <span class='st'>'square'</span><span class='op'>)</span>

<span class='co'># Perform online prediction using BOA There are 3 equivalent possibilities 1)</span>
<span class='co'># start with an empty model and update the model sequentially</span>
<span class='va'>m1.BOA</span> <span class='op'>&lt;-</span> <span class='va'>m0.BOA</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>Y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
 <span class='va'>m1.BOA</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>m1.BOA</span>, newexperts <span class='op'>=</span> <span class='va'>X</span><span class='op'>[</span><span class='va'>i</span>, <span class='op'>]</span>, newY <span class='op'>=</span> <span class='va'>Y</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'># 2) perform online prediction directly from the empty model</span>
<span class='va'>m2.BOA</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>m0.BOA</span>, newexpert <span class='op'>=</span> <span class='va'>X</span>, newY <span class='op'>=</span> <span class='va'>Y</span>, online <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>

<span class='co'># 3) perform the online aggregation directly</span>
<span class='va'>m3.BOA</span> <span class='op'>&lt;-</span> <span class='fu'>mixture</span><span class='op'>(</span>Y <span class='op'>=</span> <span class='va'>Y</span>, experts <span class='op'>=</span> <span class='va'>X</span>, model <span class='op'>=</span> <span class='st'>'BOA'</span>, loss.type <span class='op'>=</span> <span class='st'>'square'</span><span class='op'>)</span>

<span class='co'># These predictions are equivalent:</span>
<span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span><span class='va'>m1.BOA</span>, <span class='va'>m2.BOA</span><span class='op'>)</span>  <span class='co'># TRUE</span>
</div><div class='output co'>#&gt; [1] TRUE</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span><span class='va'>m1.BOA</span>, <span class='va'>m3.BOA</span><span class='op'>)</span>  <span class='co'># TRUE</span>
</div><div class='output co'>#&gt; [1] TRUE</div><div class='input'>
<span class='co'># Display the results</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>m3.BOA</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Aggregation rule: BOA 
#&gt; Loss function:  square loss 
#&gt; Gradient trick:  TRUE 
#&gt; Coefficients: 
#&gt;    gam    ar
#&gt;  0.689 0.311
#&gt; 
#&gt; Number of experts:  2
#&gt; Number of observations:  112
#&gt; Dimension of the data:  1 
#&gt; 
#&gt;         rmse   mape
#&gt; BOA     1470 0.0201
#&gt; Uniform 1480 0.0206</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>m1.BOA</span><span class='op'>)</span>
</div><div class='img'><img src='mixture-4.png' alt='' width='700' height='433' /></div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Pierre Gaillard.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


